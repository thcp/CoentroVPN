

# Split Daemon Architecture for CoentroVPN

## Objective
Implement a privileged helper daemon (`coentro-helper`) that runs with elevated privileges and handles system-level operations securely, while the main CoentroVPN client (`coentro-client`) runs unprivileged. This unlocks full VPN functionality including routing, DNS changes, and secure tunnel interface management.

## What This Enables
- Secure creation and configuration of TUN interfaces
- Programmatic control of OS-level routing tables
- System-wide or split-tunnel VPN routing
- Optional DNS override for leak prevention
- Strict privilege separation (helper runs privileged; client does not)
- Platform-agnostic interface for future mobile/desktop integration

## What We Need to Implement

### 1. coentro-helper (Privileged)
- Language: Rust
- Features:
  - Create and configure TUN interface (`tun` crate)
  - Set IP address and netmask
  - Add/remove routing rules (via `ip` or `netsh`)
  - Optional: configure DNS (e.g., via `resolvconf` or equivalent)
  - Accept IPC commands from client via:
    - Unix socket (Linux/macOS)
    - Named pipe (Windows)
  - Secure the IPC channel (auth + UID check)

### 2. coentro-client (Unprivileged)
- Language: Rust
- Features:
  - Handles QUIC, framing, AES-GCM
  - On startup, connects to helper via IPC
  - Sends setup requests: IP, routes, DNS
  - Receives TUN device or descriptor
  - Reads/writes packets to/from tunnel

### 3. IPC Layer
- Shared module `coentro-ipc`
- Protocol:
  - Serialized messages with `serde` and `bincode`
  - Example messages:
    - `SetupTun { ip, routes }`
    - `Teardown`
  - Support FD passing on Unix (via `scm_rights`)
  - Return TUN interface name (Windows)

### 4. Tests & Validation
- Integration tests: client/helper interaction
- Platform-specific TUN/routing setup
- Route injection validation
- Non-root operation test for client

### 5. Future Work
- Add gRPC or Capâ€™n Proto IPC schema
- systemd/launchd/Windows service registration
- Include helper in packaging scripts
- GUI and mobile integration
